name: Deploy Sites

on:
  push:
    branches: [main]
    paths:
      - 'apps/**'
      - 'packages/**'
      - 'pnpm-lock.yaml'
  repository_dispatch:
    types: [sanity_content_update]
  workflow_dispatch:
    inputs:
      site:
        description: 'Site to deploy'
        required: true
        type: choice
        options:
          - recon1
          - pensionable
          - senti
          - all

env:
  NODE_VERSION: '20'

jobs:
  detect-changes:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      sites: ${{ steps.changes.outputs.sites }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Detect changed sites
        id: changes
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD)
          SITES=()
          if echo "$CHANGED" | grep -qE '^apps/recon1/|^packages/'; then
            SITES+=("recon1")
          fi
          if echo "$CHANGED" | grep -qE '^apps/pensionable/|^packages/'; then
            SITES+=("pensionable")
          fi
          if echo "$CHANGED" | grep -qE '^apps/senti/|^packages/'; then
            SITES+=("senti")
          fi
          if [ ${#SITES[@]} -eq 0 ]; then
            echo "sites=[]" >> "$GITHUB_OUTPUT"
          else
            JSON=$(printf '%s\n' "${SITES[@]}" | jq -R . | jq -sc .)
            echo "sites=$JSON" >> "$GITHUB_OUTPUT"
          fi
          echo "Detected sites to deploy: ${SITES[*]:-none}"

  deploy-auto:
    if: github.event_name == 'push' && needs.detect-changes.outputs.sites != '[]'
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        site: ${{ fromJson(needs.detect-changes.outputs.sites) }}
    name: Deploy ${{ matrix.site }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @websites/${{ matrix.site }} build

      - name: Set deployment config
        id: config
        run: |
          case "${{ matrix.site }}" in
            recon1)
              echo "bucket=${{ secrets.RECON1_S3_BUCKET }}" >> "$GITHUB_OUTPUT"
              echo "cf_id=${{ secrets.RECON1_CLOUDFRONT_ID }}" >> "$GITHUB_OUTPUT"
              ;;
            pensionable)
              echo "bucket=${{ secrets.PENSIONABLE_S3_BUCKET }}" >> "$GITHUB_OUTPUT"
              echo "cf_id=${{ secrets.PENSIONABLE_CLOUDFRONT_ID }}" >> "$GITHUB_OUTPUT"
              ;;
            senti)
              echo "bucket=${{ secrets.SENTI_S3_BUCKET }}" >> "$GITHUB_OUTPUT"
              echo "cf_id=${{ secrets.SENTI_CLOUDFRONT_ID }}" >> "$GITHUB_OUTPUT"
              ;;
          esac

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy static files to S3
        run: |
          aws s3 sync apps/${{ matrix.site }}/dist/ s3://${{ steps.config.outputs.bucket }} \
            --delete \
            --cache-control "max-age=31536000,public" \
            --exclude "index.html" \
            --exclude "*.html"

      - name: Deploy HTML files to S3
        run: |
          aws s3 sync apps/${{ matrix.site }}/dist/ s3://${{ steps.config.outputs.bucket }} \
            --delete \
            --cache-control "no-cache,no-store,must-revalidate" \
            --include "*.html"

      - name: Invalidate CloudFront
        if: steps.config.outputs.cf_id != ''
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${{ steps.config.outputs.cf_id }}" \
            --paths "/*"

  deploy-webhook:
    if: github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        site: ${{ github.event.client_payload.site && fromJson(format('["{0}"]', github.event.client_payload.site)) || fromJson('["pensionable"]') }}
    name: Deploy ${{ matrix.site }} (webhook)
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @websites/${{ matrix.site }} build

      - name: Set deployment config
        id: config
        run: |
          case "${{ matrix.site }}" in
            recon1)
              echo "bucket=${{ secrets.RECON1_S3_BUCKET }}" >> "$GITHUB_OUTPUT"
              echo "cf_id=${{ secrets.RECON1_CLOUDFRONT_ID }}" >> "$GITHUB_OUTPUT"
              ;;
            pensionable)
              echo "bucket=${{ secrets.PENSIONABLE_S3_BUCKET }}" >> "$GITHUB_OUTPUT"
              echo "cf_id=${{ secrets.PENSIONABLE_CLOUDFRONT_ID }}" >> "$GITHUB_OUTPUT"
              ;;
            senti)
              echo "bucket=${{ secrets.SENTI_S3_BUCKET }}" >> "$GITHUB_OUTPUT"
              echo "cf_id=${{ secrets.SENTI_CLOUDFRONT_ID }}" >> "$GITHUB_OUTPUT"
              ;;
          esac

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy static files to S3
        run: |
          aws s3 sync apps/${{ matrix.site }}/dist/ s3://${{ steps.config.outputs.bucket }} \
            --delete \
            --cache-control "max-age=31536000,public" \
            --exclude "index.html" \
            --exclude "*.html"

      - name: Deploy HTML files to S3
        run: |
          aws s3 sync apps/${{ matrix.site }}/dist/ s3://${{ steps.config.outputs.bucket }} \
            --delete \
            --cache-control "no-cache,no-store,must-revalidate" \
            --include "*.html"

      - name: Invalidate CloudFront
        if: steps.config.outputs.cf_id != ''
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${{ steps.config.outputs.cf_id }}" \
            --paths "/*"

  deploy-manual:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        site: ${{ inputs.site == 'all' && fromJson('["recon1","pensionable","senti"]') || fromJson(format('["{0}"]', inputs.site)) }}
    name: Deploy ${{ matrix.site }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @websites/${{ matrix.site }} build

      - name: Set deployment config
        id: config
        run: |
          case "${{ matrix.site }}" in
            recon1)
              echo "bucket=${{ secrets.RECON1_S3_BUCKET }}" >> "$GITHUB_OUTPUT"
              echo "cf_id=${{ secrets.RECON1_CLOUDFRONT_ID }}" >> "$GITHUB_OUTPUT"
              ;;
            pensionable)
              echo "bucket=${{ secrets.PENSIONABLE_S3_BUCKET }}" >> "$GITHUB_OUTPUT"
              echo "cf_id=${{ secrets.PENSIONABLE_CLOUDFRONT_ID }}" >> "$GITHUB_OUTPUT"
              ;;
            senti)
              echo "bucket=${{ secrets.SENTI_S3_BUCKET }}" >> "$GITHUB_OUTPUT"
              echo "cf_id=${{ secrets.SENTI_CLOUDFRONT_ID }}" >> "$GITHUB_OUTPUT"
              ;;
          esac

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy static files to S3
        run: |
          aws s3 sync apps/${{ matrix.site }}/dist/ s3://${{ steps.config.outputs.bucket }} \
            --delete \
            --cache-control "max-age=31536000,public" \
            --exclude "index.html" \
            --exclude "*.html"

      - name: Deploy HTML files to S3
        run: |
          aws s3 sync apps/${{ matrix.site }}/dist/ s3://${{ steps.config.outputs.bucket }} \
            --delete \
            --cache-control "no-cache,no-store,must-revalidate" \
            --include "*.html"

      - name: Invalidate CloudFront
        if: steps.config.outputs.cf_id != ''
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${{ steps.config.outputs.cf_id }}" \
            --paths "/*"
